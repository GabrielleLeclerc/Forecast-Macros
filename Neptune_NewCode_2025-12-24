Option Explicit

Sub Boxes_Shipped_Forecast()
    Dim wsA As Worksheet: Set wsA = ThisWorkbook.Worksheets("Boxes_Shipped_Assumptions")
    Dim lo As ListObject: Set lo = wsA.ListObjects("WorksheetNames")

    '=== Forecast start date from assumptions ===
    Dim forecastStart As Date
    forecastStart = CDate(wsA.Range("B1").Value)

    '=== Active colors list from table "Colors" (Status = Active) ===
    Dim colors As Collection
    Set colors = GetActiveColorsFromTable("Colors", "Colors", "Status")

    If colors.Count = 0 Then
        MsgBox "No Active colors found in table 'Colors'.", vbExclamation
        Exit Sub
    End If
    
    '=== Set up / create the Debug sheet and the output row counter ===
    Dim wsDebug As Worksheet
    On Error Resume Next
    Set wsDebug = ThisWorkbook.Worksheets("Boxes_Shipped_DEBUG")
    On Error GoTo 0
    
    If wsDebug Is Nothing Then
        Set wsDebug = ThisWorkbook.Worksheets.Add(After:=ThisWorkbook.Worksheets(ThisWorkbook.Worksheets.Count))
        wsDebug.Name = "Boxes_Shipped_DEBUG"
    End If
    
    wsDebug.Cells.Clear
    wsDebug.Range("A1").Value = "Demand City"
    wsDebug.Range("B1").Value = "Color"
    wsDebug.Range("C1").Value = "Week Start"
    wsDebug.Range("D1").Value = "Week End"
    wsDebug.Range("E1").Value = "Col"
    
    wsDebug.Columns("C:D").NumberFormat = "yyyy-mm-dd"

    Dim outRow As Long
    outRow = 2
    
    Dim c As Range
    For Each c In lo.ListColumns("Worksheet").DataBodyRange.Cells
        Dim Worksheet As String
        Worksheet = Trim(CStr(c.Value))
        If Len(Worksheet) = 0 Then GoTo NextOne
        
        Dim wsT As Worksheet
        On Error Resume Next
        Set wsT = ThisWorkbook.Worksheets(Worksheet)
        On Error GoTo 0
        
        If wsT Is Nothing Then
            Debug.Print "Missing sheet:", Worksheet
        Else
            Debug.Print "Reading:", wsT.Name, "A1=", wsT.Range("A1").Value

            Dim demandCity As String
            demandCity = DemandCityFromSheetName(wsT.Name)

            '=== NEW: Build section tables (ranges) from column C headers ===
            Dim salesTbl As Range, begTbl As Range, endTbl As Range, poTbl As Range
            
            Set salesTbl = BuildSectionTable_Block(wsT, "Sales")
            Set begTbl = BuildSectionTable_Block(wsT, "Beginning Stock")
            Set endTbl = BuildSectionTable_Block(wsT, "Ending Stock")
            Set poTbl = BuildSectionTable_Block(wsT, "POs to be received")
            
            'Optional: quick debug if any section is missing
            If salesTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'Sales'"
            If begTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'Beginning Stock'"
            If endTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'Ending Stock'"
            If poTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'POs to be received'"
           
            '=== Find the forecast start column on row 2 (match forecastStart) ===
            Dim startCol As Long, lastCol As Long, col As Long
            startCol = 0
            
            lastCol = wsT.Cells(2, wsT.Columns.Count).End(xlToLeft).Column
            
            For col = 1 To lastCol
                If IsDate(wsT.Cells(2, col).Value) Then
                    If DateValue(wsT.Cells(2, col).Value) = DateValue(forecastStart) Then
                        startCol = col
                        Exit For
                    End If
                End If
            Next col
            
            If startCol = 0 Then
                Debug.Print "Forecast start date not found on row 2 for sheet:", wsT.Name, "Start:", Format(forecastStart, "yyyy-mm-dd")
            Else
                '=== Loop week columns from forecastStart onward ===
                For col = startCol To lastCol
                    If Not IsDate(wsT.Cells(2, col).Value) Then Exit For
                    
                    Dim colLetter As String
                    colLetter = Split(wsT.Cells(1, col).Address(False, False), "1")(0)
                    
                    Dim i As Long
                    For i = 1 To colors.Count
                        wsDebug.Cells(outRow, "A").Value = demandCity
                        wsDebug.Cells(outRow, "B").Value = colors(i)
                        wsDebug.Cells(outRow, "C").Value = wsT.Cells(2, col).Value
                        wsDebug.Cells(outRow, "D").Value = wsT.Cells(4, col).Value
                        wsDebug.Cells(outRow, "E").Value = colLetter
                        outRow = outRow + 1
                    Next i
                Next col
            End If
        End If
        
NextOne:
        Set wsT = Nothing
    Next c
End Sub

'=== City Name Mapping ===
Private Function DemandCityFromSheetName(ByVal sheetName As String) As String
    Select Case sheetName
        Case "Neptune-Montreal":  DemandCityFromSheetName = "Montreal"
        Case "Neptune-Vancouver": DemandCityFromSheetName = "Vancouver"
        Case "Neptune-Toronto":   DemandCityFromSheetName = "Toronto"
        Case "Neptune-Moreno":    DemandCityFromSheetName = "Moreno"
        Case "Neptune-Dayton":    DemandCityFromSheetName = "Dayton"
        Case Else
            DemandCityFromSheetName = "UNKNOWN (" & sheetName & ")"
    End Select
End Function

'=== Section Table Builder ===
'Finds a section header in column C (exact match),
'then returns the block of rows for that section down to the row before the next section header,
'and out to the last week-start date column (last date in row 2).
Private Function BuildSectionTable_Block(ByVal ws As Worksheet, ByVal sectionHeader As String) As Range
    Dim headerCell As Range
    Set headerCell = FindInColumnExact(ws, "C", sectionHeader)
    
    If headerCell Is Nothing Then
        Set BuildSectionTable_Block = Nothing
        Exit Function
    End If
    
    Dim startRow As Long
    startRow = headerCell.Row + 1
    
    'Find end row: stop right before the next section header (or at last used row in column C)
    Dim lastRowC As Long
    lastRowC = ws.Cells(ws.Rows.Count, "C").End(xlUp).Row
    
    Dim r As Long, endRow As Long
    endRow = lastRowC
    
    For r = startRow + 1 To lastRowC
        If IsSectionHeader(ws.Cells(r, "C").Value) Then
            endRow = r - 1
            Exit For
        End If
    Next r
    
    'Find the rightmost column: last week-start entry (last date in row 2)
    Dim lastWeekCol As Long
    lastWeekCol = FindLastDateColumnInRow(ws, 2)
    
    If lastWeekCol = 0 Then
        'Fallback: if row 2 has no dates, just return columns C:E
        lastWeekCol = ws.Range("E1").Column
    End If
    
    Set BuildSectionTable_Block = ws.Range(ws.Cells(startRow, "C"), ws.Cells(endRow, lastWeekCol))
End Function

'Helper: exact match search in a single column
Private Function FindInColumnExact(ByVal ws As Worksheet, ByVal colLetter As String, ByVal textToFind As String) As Range
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, colLetter).End(xlUp).Row
    
    Dim r As Long
    For r = 1 To lastRow
        If Trim$(CStr(ws.Cells(r, colLetter).Value)) = textToFind Then
            Set FindInColumnExact = ws.Cells(r, colLetter)
            Exit Function
        End If
    Next r
    
    Set FindInColumnExact = Nothing
End Function

'Helper: defines what counts as a section header in column C
Private Function IsSectionHeader(ByVal v As Variant) As Boolean
    Dim s As String
    s = Trim$(CStr(v))
    
    Select Case s
        Case "Beginning Stock", "Ending Stock", "Sales", "POs to be received", "Stock Turnover"
            IsSectionHeader = True
        Case Else
            IsSectionHeader = False
    End Select
End Function

'Returns the column number of the rightmost cell in a row that contains a date.
'If no date is found, returns 0.
Private Function FindLastDateColumnInRow(ByVal ws As Worksheet, ByVal rowNum As Long) As Long
    Dim lastCol As Long
    lastCol = ws.Cells(rowNum, ws.Columns.Count).End(xlToLeft).Column
    
    Dim c As Long
    For c = lastCol To 1 Step -1
        If IsDate(ws.Cells(rowNum, c).Value) Then
            FindLastDateColumnInRow = c
            Exit Function
        End If
    Next c
    
    FindLastDateColumnInRow = 0
End Function

'Adds unique normalized colors found in column E of a section range.
'Implements fill-down: blank color cells inherit the most recent non-blank color above within that section scan.
Private Sub AddColorsFromSection(ByRef colors As Collection, ByVal sectionRng As Range)
    Dim lastSeen As String
    lastSeen = ""
    
    Dim r As Long
    For r = 1 To sectionRng.Rows.Count
        Dim raw As String
        raw = Trim$(CStr(sectionRng.Cells(r, 3).Value)) 'Column E relative to sectionRng (C=1, D=2, E=3)
        
        If Len(raw) > 0 Then
            lastSeen = NormalizeColor(raw)
        ElseIf Len(lastSeen) > 0 Then
            'fill-down: use lastSeen
        Else
            'still nothing to use
        End If
        
        If Len(lastSeen) > 0 Then
            AddUniqueKeyed colors, lastSeen
        End If
    Next r
End Sub

'Normalize color strings so duplicates like " fog ", "FOG", "Fog" collapse to one key.
Private Function NormalizeColor(ByVal s As String) As String
    s = Trim$(s)
    If Len(s) = 0 Then
        NormalizeColor = ""
    Else
        NormalizeColor = UCase$(s)
    End If
End Function

'Cross-platform uniqueness using Collection keys (no Dictionary required).
Private Sub AddUniqueKeyed(ByRef col As Collection, ByVal key As String)
    On Error Resume Next
    col.Add key, key   'keyed add: duplicates throw error
    Err.Clear
    On Error GoTo 0
End Sub

'Returns a UNIQUE list of colors from a ListObject table where Status = "Active".
'TableName: name of the Excel table (ListObject), e.g. "Colors"
'ColorColName: header name for the color column, e.g. "Colors"
'StatusColName: header name for status, e.g. "Status"
Private Function GetActiveColorsFromTable(ByVal tableName As String, _
                                         ByVal colorColName As String, _
                                         ByVal statusColName As String) As Collection
    Dim result As New Collection
    
    Dim ws As Worksheet, lo As ListObject
    Dim found As Boolean
    found = False
    
    'Find the table anywhere in ThisWorkbook
    For Each ws In ThisWorkbook.Worksheets
        On Error Resume Next
        Set lo = ws.ListObjects(tableName)
        On Error GoTo 0
        
        If Not lo Is Nothing Then
            found = True
            Exit For
        End If
    Next ws
    
    If Not found Then
        'Return empty collection (or raise error if you prefer)
        Set GetActiveColorsFromTable = result
        Exit Function
    End If
    
    Dim colColor As ListColumn, colStatus As ListColumn
    Set colColor = lo.ListColumns(colorColName)
    Set colStatus = lo.ListColumns(statusColName)
    
    If lo.DataBodyRange Is Nothing Then
        Set GetActiveColorsFromTable = result
        Exit Function
    End If
    
    Dim i As Long
    For i = 1 To lo.DataBodyRange.Rows.Count
        Dim statusVal As String
        statusVal = Trim$(CStr(colStatus.DataBodyRange.Cells(i, 1).Value))
        
        If UCase$(statusVal) = "ACTIVE" Then
            Dim clr As String
            clr = NormalizeColor(CStr(colColor.DataBodyRange.Cells(i, 1).Value))
            If Len(clr) > 0 Then
                AddUniqueKeyed result, clr
            End If
        End If
    Next i
    
    Set GetActiveColorsFromTable = result
End Function
