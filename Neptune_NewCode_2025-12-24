Option Explicit

Sub Boxes_Shipped_Forecast()
    Dim wsA As Worksheet: Set wsA = ThisWorkbook.Worksheets("Boxes_Shipped_Assumptions")
    Dim lo As ListObject: Set lo = wsA.ListObjects("WorksheetNames")

    '=== Forecast start date from assumptions ===
    Dim forecastStart As Date
    forecastStart = CDate(wsA.Range("B1").Value)

    '=== Set up / create the Debug sheet and the output row counter ===
    Dim wsDebug As Worksheet
    On Error Resume Next
    Set wsDebug = ThisWorkbook.Worksheets("Boxes_Shipped_DEBUG")
    On Error GoTo 0
    
    If wsDebug Is Nothing Then
        Set wsDebug = ThisWorkbook.Worksheets.Add(After:=ThisWorkbook.Worksheets(ThisWorkbook.Worksheets.Count))
        wsDebug.Name = "Boxes_Shipped_DEBUG"
    End If
    
    wsDebug.Cells.Clear
    wsDebug.Range("A1").Value = "Demand City"
    wsDebug.Range("B1").Value = "Week Start"
    wsDebug.Range("C1").Value = "Week End"
    wsDebug.Range("D1").Value = "Col"

    wsDebug.Columns("B:C").NumberFormat = "yyyy-mm-dd"
    
    Dim outRow As Long
    outRow = 2
    
    Dim c As Range
    For Each c In lo.ListColumns("Worksheet").DataBodyRange.Cells
        Dim Worksheet As String
        Worksheet = Trim(CStr(c.Value))
        If Len(Worksheet) = 0 Then GoTo NextOne
        
        Dim wsT As Worksheet
        On Error Resume Next
        Set wsT = ThisWorkbook.Worksheets(Worksheet)
        On Error GoTo 0
        
        If wsT Is Nothing Then
            Debug.Print "Missing sheet:", Worksheet
        Else
            Debug.Print "Reading:", wsT.Name, "A1=", wsT.Range("A1").Value

            Dim demandCity As String
            demandCity = DemandCityFromSheetName(wsT.Name)

            '=== NEW: Build section tables (ranges) from column C headers ===
            Dim salesTbl As Range, begTbl As Range, endTbl As Range, poTbl As Range
            
            Set salesTbl = BuildSectionTable_Block(wsT, "Sales")
            Set begTbl = BuildSectionTable_Block(wsT, "Beginning Stock")
            Set endTbl = BuildSectionTable_Block(wsT, "Ending Stock")
            Set poTbl = BuildSectionTable_Block(wsT, "POs to be received")
            
            'Optional: quick debug if any section is missing
            If salesTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'Sales'"
            If begTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'Beginning Stock'"
            If endTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'Ending Stock'"
            If poTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'POs to be received'"

            
            '=== Find the forecast start column on row 2 (match forecastStart) ===
            Dim startCol As Long, lastCol As Long, col As Long
            startCol = 0
            
            lastCol = wsT.Cells(2, wsT.Columns.Count).End(xlToLeft).Column
            
            For col = 1 To lastCol
                If IsDate(wsT.Cells(2, col).Value) Then
                    If DateValue(wsT.Cells(2, col).Value) = DateValue(forecastStart) Then
                        startCol = col
                        Exit For
                    End If
                End If
            Next col
            
            If startCol = 0 Then
                Debug.Print "Forecast start date not found on row 2 for sheet:", wsT.Name, "Start:", Format(forecastStart, "yyyy-mm-dd")
            Else
                '=== Loop week columns from forecastStart onward ===
                For col = startCol To lastCol
                    If Not IsDate(wsT.Cells(2, col).Value) Then Exit For
                    
                    wsDebug.Cells(outRow, "A").Value = demandCity
                    wsDebug.Cells(outRow, "B").Value = wsT.Cells(2, col).Value
                    wsDebug.Cells(outRow, "C").Value = wsT.Cells(4, col).Value
                    wsDebug.Cells(outRow, "D").Value = Split(wsT.Cells(1, col).Address(False, False), "1")(0)
                    
                    outRow = outRow + 1
                Next col
            End If
        End If
        
NextOne:
        Set wsT = Nothing
    Next c
End Sub

'=== City Name Mapping ===
Private Function DemandCityFromSheetName(ByVal sheetName As String) As String
    Select Case sheetName
        Case "Neptune-Montreal":  DemandCityFromSheetName = "Montreal"
        Case "Neptune-Vancouver": DemandCityFromSheetName = "Vancouver"
        Case "Neptune-Toronto":   DemandCityFromSheetName = "Toronto"
        Case "Neptune-Moreno":    DemandCityFromSheetName = "Moreno"
        Case "Neptune-Dayton":    DemandCityFromSheetName = "Dayton"
        Case Else
            DemandCityFromSheetName = "UNKNOWN (" & sheetName & ")"
    End Select
End Function

'=== Section Table Builder ===
'Finds a section header in column C (exact match),
'then returns the block of rows for that section down to the row before the next section header,
'and out to the last week-start date column (last date in row 2).
Private Function BuildSectionTable_Block(ByVal ws As Worksheet, ByVal sectionHeader As String) As Range
    Dim headerCell As Range
    Set headerCell = FindInColumnExact(ws, "C", sectionHeader)
    
    If headerCell Is Nothing Then
        Set BuildSectionTable_Block = Nothing
        Exit Function
    End If
    
    Dim startRow As Long
    startRow = headerCell.Row + 1
    
    'Find end row: stop right before the next section header (or at last used row in column C)
    Dim lastRowC As Long
    lastRowC = ws.Cells(ws.Rows.Count, "C").End(xlUp).Row
    
    Dim r As Long, endRow As Long
    endRow = lastRowC
    
    For r = startRow + 1 To lastRowC
        If IsSectionHeader(ws.Cells(r, "C").Value) Then
            endRow = r - 1
            Exit For
        End If
    Next r
    
    'Find the rightmost column: last week-start entry (last date in row 2)
    Dim lastWeekCol As Long
    lastWeekCol = FindLastDateColumnInRow(ws, 2)
    
    If lastWeekCol = 0 Then
        'Fallback: if row 2 has no dates, just return columns C:E
        lastWeekCol = ws.Range("E1").Column
    End If
    
    Set BuildSectionTable_Block = ws.Range(ws.Cells(startRow, "C"), ws.Cells(endRow, lastWeekCol))
End Function

'Helper: exact match search in a single column
Private Function FindInColumnExact(ByVal ws As Worksheet, ByVal colLetter As String, ByVal textToFind As String) As Range
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, colLetter).End(xlUp).Row
    
    Dim r As Long
    For r = 1 To lastRow
        If Trim$(CStr(ws.Cells(r, colLetter).Value)) = textToFind Then
            Set FindInColumnExact = ws.Cells(r, colLetter)
            Exit Function
        End If
    Next r
    
    Set FindInColumnExact = Nothing
End Function

'Helper: defines what counts as a section header in column C
Private Function IsSectionHeader(ByVal v As Variant) As Boolean
    Dim s As String
    s = Trim$(CStr(v))
    
    Select Case s
        Case "Beginning Stock", "Ending Stock", "Sales", "POs to be received"
            IsSectionHeader = True
        Case Else
            IsSectionHeader = False
    End Select
End Function

'Returns the column number of the rightmost cell in a row that contains a date.
'If no date is found, returns 0.
Private Function FindLastDateColumnInRow(ByVal ws As Worksheet, ByVal rowNum As Long) As Long
    Dim lastCol As Long
    lastCol = ws.Cells(rowNum, ws.Columns.Count).End(xlToLeft).Column
    
    Dim c As Long
    For c = lastCol To 1 Step -1
        If IsDate(ws.Cells(rowNum, c).Value) Then
            FindLastDateColumnInRow = c
            Exit Function
        End If
    Next c
    
    FindLastDateColumnInRow = 0
End Function

