Option Explicit

Public MAX_BOX As Long

Sub Boxes_Shipped_Forecast()
    Dim oldCalc As XlCalculation
    oldCalc = Application.Calculation
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual
    Application.DisplayStatusBar = True

    Dim wsA As Worksheet: Set wsA = ThisWorkbook.Worksheets("Boxes_Shipped_Assumptions")
    Dim lo As ListObject: Set lo = wsA.ListObjects("WorksheetNames")

    '=== Forecast start date from assumptions ===
    Dim forecastStart As Date
    forecastStart = CDate(wsA.Range("B1").Value)

    '=== Active colors list from table "Colors" (Status = Active) ===
    Dim colors As Collection
    Set colors = GetActiveColorsFromTable("Colors", "Colors", "Status")

    If colors.Count = 0 Then
        MsgBox "No Active colors found in table 'Colors'.", vbExclamation
        Exit Sub
    End If

    '=== MAX_BOX driven by table "Boxes" row count (data rows only) ===
    MAX_BOX = GetBoxCountFromTable("Boxes")
    If MAX_BOX <= 0 Then
        MsgBox "Table 'Boxes' not found or has no rows.", vbExclamation
        Exit Sub
    End If
            
    '=== Set up / create the Debug sheet and the output row counter ===
    Dim wsDebug As Worksheet
    On Error Resume Next
    Set wsDebug = ThisWorkbook.Worksheets("Boxes_Shipped_DEBUG")
    On Error GoTo 0
    
    If wsDebug Is Nothing Then
        Set wsDebug = ThisWorkbook.Worksheets.Add(After:=ThisWorkbook.Worksheets(ThisWorkbook.Worksheets.Count))
        wsDebug.Name = "Boxes_Shipped_DEBUG"
    End If
    
    wsDebug.Cells.Clear
    wsDebug.Range("A1").Value = "Demand City"
    wsDebug.Range("B1").Value = "Color"
    wsDebug.Range("C1").Value = "Week Start"
    wsDebug.Range("D1").Value = "Week End"
    wsDebug.Range("E1").Value = "Col"

    '=== NEW: Add box columns ===  
    Dim b As Long, hdrCol As Long
    
    hdrCol = 6 ' Column F = first new header
    
    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "Sales B" & b
        hdrCol = hdrCol + 1
    Next b
    
    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "Beg Stock B" & b
        hdrCol = hdrCol + 1
    Next b
    
    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "IB B" & b
        hdrCol = hdrCol + 1
    Next b
    
    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "AvailStock B" & b
        hdrCol = hdrCol + 1
    Next b

    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "Backlog B" & b
        hdrCol = hdrCol + 1
    Next b

    '=== Allocation Round 1 columns (Backlog first) ===
    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "BacklogShipped B" & b
        hdrCol = hdrCol + 1
    Next b
    
    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "AvailStock_PostBacklog B" & b
        hdrCol = hdrCol + 1
    Next b
    
    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "Backlog_P1 B" & b
        hdrCol = hdrCol + 1
    Next b

    '=== Allocation Round 2 columns (Sales after backlog) ===
    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "SalesShipped B" & b
        hdrCol = hdrCol + 1
    Next b
    
    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "AvailStock_PostSales B" & b
        hdrCol = hdrCol + 1
    Next b
    
    For b = 1 To MAX_BOX
        wsDebug.Cells(1, hdrCol).Value = "Sales_P1 B" & b
        hdrCol = hdrCol + 1
    Next b
    
    '=== Totals (across all boxes) ===
    wsDebug.Cells(1, hdrCol).Value = "TotalLocalBacklogShipped"
    hdrCol = hdrCol + 1
    
    wsDebug.Cells(1, hdrCol).Value = "TotalLocalSalesShipped"
    hdrCol = hdrCol + 1


    'Force integer display for all box metric columns (Sales..Backlog)
    wsDebug.Range(wsDebug.Cells(2, 6), wsDebug.Cells(wsDebug.Rows.Count, hdrCol - 1)).NumberFormat = "0"
    
    wsDebug.Columns("C:D").NumberFormat = "yyyy-mm-dd"

    Dim outRow As Long
    outRow = 2
    
    Dim c As Range
    For Each c In lo.ListColumns("Worksheet").DataBodyRange.Cells
        Dim Worksheet As String
        Worksheet = Trim(CStr(c.Value))
        If Len(Worksheet) = 0 Then GoTo NextOne
        
        Dim wsT As Worksheet
        On Error Resume Next
        Set wsT = ThisWorkbook.Worksheets(Worksheet)
        On Error GoTo 0
        
        If wsT Is Nothing Then
            Debug.Print "Missing sheet:", Worksheet
        Else
            Debug.Print "Reading:", wsT.Name, "A1=", wsT.Range("A1").Value

            Dim demandCity As String
            demandCity = DemandCityFromSheetName(wsT.Name)

            '=== NEW: Build section tables (ranges) from column C headers ===
            Dim salesTbl As Range, begTbl As Range, endTbl As Range, poTbl As Range
            
            Set salesTbl = BuildSectionTable_Block(wsT, "Sales")
            Set begTbl = BuildSectionTable_Block(wsT, "Beginning Stock")
            Set endTbl = BuildSectionTable_Block(wsT, "Ending Stock")
            Set poTbl = BuildSectionTable_Block(wsT, "POs to be received")
            
            'Optional: quick debug if any section is missing
            If salesTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'Sales'"
            If begTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'Beginning Stock'"
            If endTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'Ending Stock'"
            If poTbl Is Nothing Then Debug.Print wsT.Name & ": Missing section 'POs to be received'"

            '=== Build section INDEX tables (Color+Box -> Row) ===
            Dim salesIdx As Variant, begIdx As Variant, endIdx As Variant, poIdx As Variant
            
            salesIdx = BuildSectionIndex_FromRange(salesTbl)
            begIdx   = BuildSectionIndex_FromRange(begTbl)
            endIdx   = BuildSectionIndex_FromRange(endTbl)
            poIdx    = BuildSectionIndex_FromRange(poTbl)

            '=== FAST MAPS (Color|Box -> Row) to avoid scanning arrays repeatedly ===
            Dim salesMap As Object, begMap As Object, poMap As Object
            Set salesMap = BuildRowMap(salesIdx)
            Set begMap   = BuildRowMap(begIdx)
            Set poMap    = BuildRowMap(poIdx)
            
            '=== Find the forecast start column on row 2 (match forecastStart) ===
            Dim startCol As Long, lastCol As Long, col As Long
            startCol = 0
            
            lastCol = wsT.Cells(2, wsT.Columns.Count).End(xlToLeft).Column
            
            For col = 1 To lastCol
                If IsDate(wsT.Cells(2, col).Value) Then
                    If DateValue(wsT.Cells(2, col).Value) = DateValue(forecastStart) Then
                        startCol = col
                        Exit For
                    End If
                End If
            Next col
            
            If startCol = 0 Then
                Debug.Print "Forecast start date not found on row 2 for sheet:", wsT.Name, "Start:", Format(forecastStart, "yyyy-mm-dd")
            Else
                '=== Loop week columns from forecastStart onward ===
                For col = startCol To lastCol
                    If Not IsDate(wsT.Cells(2, col).Value) Then Exit For
                    
                    Dim colLetter As String
                    colLetter = Split(wsT.Cells(1, col).Address(False, False), "1")(0)
                    
                    Dim i As Long
                    For i = 1 To colors.Count
                        
                        Dim colorKey As String
                        colorKey = NormalizeColor(colors(i))  ' make sure it matches index normalization
                        
                        wsDebug.Cells(outRow, "A").Value = demandCity
                        wsDebug.Cells(outRow, "B").Value = colors(i)
                        wsDebug.Cells(outRow, "C").Value = wsT.Cells(2, col).Value
                        wsDebug.Cells(outRow, "D").Value = wsT.Cells(4, col).Value
                        wsDebug.Cells(outRow, "E").Value = colLetter
                        
                        '=== NEW: populate Sales / Beginning Stock / Inbound for each box ===
                        Dim writeCol As Long
                        writeCol = 6   ' Column F = first box data column
                        
                        Dim rr As Long, v As Variant
                        
                        '--- Sales B1..Bn ---
                        Dim key As String
                        For b = 1 To MAX_BOX
                            key = colorKey & "|" & CStr(b)
                        
                            rr = MapGetLong(salesMap, key, 0)
                            If rr > 0 Then
                                wsDebug.Cells(outRow, writeCol).Value = ToWhole(wsT.Cells(rr, col).Value)
                            Else
                                wsDebug.Cells(outRow, writeCol).Value = 0
                            End If
                        
                            writeCol = writeCol + 1
                        Next b
                    
                        '--- Beginning Stock B1..Bn ---
                        For b = 1 To MAX_BOX
                            key = colorKey & "|" & CStr(b)
                        
                            rr = MapGetLong(begMap, key, 0)
                            If rr > 0 Then
                                wsDebug.Cells(outRow, writeCol).Value = ToWhole(wsT.Cells(rr, col).Value)
                            Else
                                wsDebug.Cells(outRow, writeCol).Value = 0
                            End If
                        
                            writeCol = writeCol + 1
                        Next b

                        '--- Inbound B1..Bn (POs to be received) ---
                        For b = 1 To MAX_BOX
                            key = colorKey & "|" & CStr(b)
                        
                            rr = MapGetLong(poMap, key, 0)
                            If rr > 0 Then
                                wsDebug.Cells(outRow, writeCol).Value = ToWhole(wsT.Cells(rr, col).Value)
                            Else
                                wsDebug.Cells(outRow, writeCol).Value = 0
                            End If
                        
                            writeCol = writeCol + 1
                        Next b

                        '--- AvailStock B1..Bn = MAX(0, Beg Stock + IB) ---
                        Dim begCol As Long, ibCol As Long
                        Dim sumAvail As Double
                        
                        For b = 1 To MAX_BOX
                            begCol = 6 + MAX_BOX + (b - 1)         'Beg Stock block starts after Sales
                            ibCol  = 6 + (2 * MAX_BOX) + (b - 1)   'IB block starts after Sales+Beg
                        
                            sumAvail = CLng(wsDebug.Cells(outRow, begCol).Value) + CLng(wsDebug.Cells(outRow, ibCol).Value)

                            If sumAvail < 0 Then
                                wsDebug.Cells(outRow, writeCol).Value = 0
                            Else
                                wsDebug.Cells(outRow, writeCol).Value = CLng(sumAvail)
                            End If
                        
                            writeCol = writeCol + 1
                        Next b

                        '--- Backlog B1..Bn = IF(Beg Stock < 0, ABS(Beg Stock), 0) ---
                        Dim begVal As Double
                        For b = 1 To MAX_BOX
                            begCol = 6 + MAX_BOX + (b - 1) 'same begCol logic as above
                            begVal = CLng(wsDebug.Cells(outRow, begCol).Value)

                            If begVal < 0 Then
                                wsDebug.Cells(outRow, writeCol).Value = CLng(Abs(begVal))
                            Else
                                wsDebug.Cells(outRow, writeCol).Value = 0
                            End If

                        
                            writeCol = writeCol + 1
                        Next b

                        '=== Allocation Round 1 (Backlog-first) ===
                        'Uses the already-written AvailStock and Backlog values from this same row.
                        
                        Dim availCol As Long, backlogCol As Long
                        Dim availVal As Long, backlogVal As Long
                        Dim shippedBacklog As Long, availPost As Long, backlogP1 As Long
                        
                        'Column block start positions (based on your layout):
                        'Sales:      6
                        'Beg Stock:  6 + 1*MAX_BOX
                        'IB:         6 + 2*MAX_BOX
                        'AvailStock: 6 + 3*MAX_BOX
                        'Backlog:    6 + 4*MAX_BOX
                        
                        '--- BacklogShipped B1..Bn = MIN(AvailStock, Backlog) ---
                        For b = 1 To MAX_BOX
                            availCol = 6 + (3 * MAX_BOX) + (b - 1)
                            backlogCol = 6 + (4 * MAX_BOX) + (b - 1)
                        
                            availVal = CLng(wsDebug.Cells(outRow, availCol).Value)
                            backlogVal = CLng(wsDebug.Cells(outRow, backlogCol).Value)
                        
                            shippedBacklog = availVal
                            If backlogVal < shippedBacklog Then shippedBacklog = backlogVal
                        
                            wsDebug.Cells(outRow, writeCol).Value = shippedBacklog
                            writeCol = writeCol + 1
                        Next b
                        
                        '--- AvailStock_PostBacklog B1..Bn = MAX(AvailStock - Backlog, 0) ---
                        For b = 1 To MAX_BOX
                            availCol = 6 + (3 * MAX_BOX) + (b - 1)
                            backlogCol = 6 + (4 * MAX_BOX) + (b - 1)
                        
                            availVal = CLng(wsDebug.Cells(outRow, availCol).Value)
                            backlogVal = CLng(wsDebug.Cells(outRow, backlogCol).Value)
                        
                            availPost = availVal - backlogVal
                            If availPost < 0 Then availPost = 0
                        
                            wsDebug.Cells(outRow, writeCol).Value = availPost
                            writeCol = writeCol + 1
                        Next b
                        
                        '--- Backlog_P1 B1..Bn = MAX(Backlog - AvailStock, 0) ---
                        For b = 1 To MAX_BOX
                            availCol = 6 + (3 * MAX_BOX) + (b - 1)
                            backlogCol = 6 + (4 * MAX_BOX) + (b - 1)
                        
                            availVal = CLng(wsDebug.Cells(outRow, availCol).Value)
                            backlogVal = CLng(wsDebug.Cells(outRow, backlogCol).Value)
                        
                            backlogP1 = backlogVal - availVal
                            If backlogP1 < 0 Then backlogP1 = 0
                        
                            wsDebug.Cells(outRow, writeCol).Value = backlogP1
                            writeCol = writeCol + 1
                        Next b

                        '=== Allocation Round 2 (Sales using AvailStock_PostBacklog) ===
                        'Uses already-written Sales and AvailStock_PostBacklog from this same row.
                        
                        Dim salesCol As Long, availPostBacklogCol As Long
                        Dim salesVal As Long, availPostBacklogVal As Long
                        Dim shippedSales As Long, availPostSales As Long, salesP1 As Long
                        
                        'Column block start positions (based on your layout + Round 1 blocks):
                        'Sales:                  6 + 0*MAX_BOX
                        'Beg Stock:              6 + 1*MAX_BOX
                        'IB:                     6 + 2*MAX_BOX
                        'AvailStock:             6 + 3*MAX_BOX
                        'Backlog:                6 + 4*MAX_BOX
                        'BacklogShipped:         6 + 5*MAX_BOX
                        'AvailStock_PostBacklog: 6 + 6*MAX_BOX
                        'Backlog_P1:             6 + 7*MAX_BOX
                        
                        '--- SalesShipped B1..Bn = MIN(AvailStock_PostBacklog, Sales) ---
                        For b = 1 To MAX_BOX
                            salesCol = 6 + (0 * MAX_BOX) + (b - 1)
                            availPostBacklogCol = 6 + (6 * MAX_BOX) + (b - 1)
                        
                            salesVal = CLng(wsDebug.Cells(outRow, salesCol).Value)
                            availPostBacklogVal = CLng(wsDebug.Cells(outRow, availPostBacklogCol).Value)
                        
                            shippedSales = availPostBacklogVal
                            If salesVal < shippedSales Then shippedSales = salesVal
                        
                            wsDebug.Cells(outRow, writeCol).Value = shippedSales
                            writeCol = writeCol + 1
                        Next b
                        
                        '--- AvailStock_PostSales B1..Bn = MAX(AvailStock_PostBacklog - Sales, 0) ---
                        For b = 1 To MAX_BOX
                            salesCol = 6 + (0 * MAX_BOX) + (b - 1)
                            availPostBacklogCol = 6 + (6 * MAX_BOX) + (b - 1)
                        
                            salesVal = CLng(wsDebug.Cells(outRow, salesCol).Value)
                            availPostBacklogVal = CLng(wsDebug.Cells(outRow, availPostBacklogCol).Value)
                        
                            availPostSales = availPostBacklogVal - salesVal
                            If availPostSales < 0 Then availPostSales = 0
                        
                            wsDebug.Cells(outRow, writeCol).Value = availPostSales
                            writeCol = writeCol + 1
                        Next b
                        
                        '--- Sales_P1 B1..Bn = MAX(Sales - AvailStock_PostBacklog, 0) ---
                        For b = 1 To MAX_BOX
                            salesCol = 6 + (0 * MAX_BOX) + (b - 1)
                            availPostBacklogCol = 6 + (6 * MAX_BOX) + (b - 1)
                        
                            salesVal = CLng(wsDebug.Cells(outRow, salesCol).Value)
                            availPostBacklogVal = CLng(wsDebug.Cells(outRow, availPostBacklogCol).Value)
                        
                            salesP1 = salesVal - availPostBacklogVal
                            If salesP1 < 0 Then salesP1 = 0
                        
                            wsDebug.Cells(outRow, writeCol).Value = salesP1
                            writeCol = writeCol + 1
                        Next b

                        '=== Totals across boxes ===
                        Dim totalBacklogShipped As Long, totalSalesShipped As Long
                        Dim backlogShippedCol As Long, salesShippedCol As Long
                        
                        totalBacklogShipped = 0
                        totalSalesShipped = 0
                        
                        'BacklogShipped block starts at: 6 + 5*MAX_BOX
                        'SalesShipped block starts at:   6 + 8*MAX_BOX
                        For b = 1 To MAX_BOX
                            backlogShippedCol = 6 + (5 * MAX_BOX) + (b - 1)
                            salesShippedCol = 6 + (8 * MAX_BOX) + (b - 1)
                        
                            totalBacklogShipped = totalBacklogShipped + CLng(wsDebug.Cells(outRow, backlogShippedCol).Value)
                            totalSalesShipped = totalSalesShipped + CLng(wsDebug.Cells(outRow, salesShippedCol).Value)
                        Next b
                        
                        'Write totals into the next 2 columns at the end of the row
                        wsDebug.Cells(outRow, writeCol).Value = totalBacklogShipped
                        writeCol = writeCol + 1
                        
                        wsDebug.Cells(outRow, writeCol).Value = totalSalesShipped
                        writeCol = writeCol + 1
                                                                     
                        outRow = outRow + 1
                    Next i
                Next col
            End If
        End If
        
NextOne:
        Set wsT = Nothing
    Next c

    Application.Calculation = oldCalc
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Application.StatusBar = False

    MsgBox "Boxes Shipped Forecast Ran Successfully", vbInformation
End Sub

'=== City Name Mapping ===
Private Function DemandCityFromSheetName(ByVal sheetName As String) As String
    Select Case sheetName
        Case "Neptune-Montreal":  DemandCityFromSheetName = "Montreal"
        Case "Neptune-Vancouver": DemandCityFromSheetName = "Vancouver"
        Case "Neptune-Toronto":   DemandCityFromSheetName = "Toronto"
        Case "Neptune-Moreno":    DemandCityFromSheetName = "Moreno"
        Case "Neptune-Dayton":    DemandCityFromSheetName = "Dayton"
        Case Else
            DemandCityFromSheetName = "UNKNOWN (" & sheetName & ")"
    End Select
End Function

'=== Section Table Builder ===
'Finds a section header in column C (exact match),
'then returns the block of rows for that section down to the row before the next section header,
'and out to the last week-start date column (last date in row 2).
Private Function BuildSectionTable_Block(ByVal ws As Worksheet, ByVal sectionHeader As String) As Range
    Dim headerCell As Range
    Set headerCell = FindInColumnExact(ws, "C", sectionHeader)
    
    If headerCell Is Nothing Then
        Set BuildSectionTable_Block = Nothing
        Exit Function
    End If
    
    Dim startRow As Long
    startRow = headerCell.Row + 1
    
    'Find end row: stop right before the next section header (or at last used row in column C)
    Dim lastRowC As Long
    lastRowC = ws.Cells(ws.Rows.Count, "C").End(xlUp).Row
    
    Dim r As Long, endRow As Long
    endRow = lastRowC
    
    For r = startRow + 1 To lastRowC
        If IsSectionHeader(ws.Cells(r, "C").Value) Then
            endRow = r - 1
            Exit For
        End If
    Next r
    
    'Find the rightmost column: last week-start entry (last date in row 2)
    Dim lastWeekCol As Long
    lastWeekCol = FindLastDateColumnInRow(ws, 2)
    
    If lastWeekCol = 0 Then
        'Fallback: if row 2 has no dates, just return columns C:E
        lastWeekCol = ws.Range("E1").Column
    End If
    
    Set BuildSectionTable_Block = ws.Range(ws.Cells(startRow, "C"), ws.Cells(endRow, lastWeekCol))
End Function

'Helper: exact match search in a single column
Private Function FindInColumnExact(ByVal ws As Worksheet, ByVal colLetter As String, ByVal textToFind As String) As Range
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, colLetter).End(xlUp).Row
    
    Dim r As Long
    For r = 1 To lastRow
        If UCase$(Trim$(CStr(ws.Cells(r, colLetter).Value))) = UCase$(Trim$(textToFind)) Then
            Set FindInColumnExact = ws.Cells(r, colLetter)
            Exit Function
        End If
    Next r
    
    Set FindInColumnExact = Nothing
End Function

'Helper: defines what counts as a section header in column C
Private Function IsSectionHeader(ByVal v As Variant) As Boolean
    Dim s As String
    s = Trim$(CStr(v))
    
    Select Case s
        Case "Beginning Stock", "Ending Stock", "Sales", "POs to be received", "Stock Turnover"
            IsSectionHeader = True
        Case Else
            IsSectionHeader = False
    End Select
End Function

'Returns the column number of the rightmost cell in a row that contains a date.
'If no date is found, returns 0.
Private Function FindLastDateColumnInRow(ByVal ws As Worksheet, ByVal rowNum As Long) As Long
    Dim lastCol As Long
    lastCol = ws.Cells(rowNum, ws.Columns.Count).End(xlToLeft).Column
    
    Dim c As Long
    For c = lastCol To 1 Step -1
        If IsDate(ws.Cells(rowNum, c).Value) Then
            FindLastDateColumnInRow = c
            Exit Function
        End If
    Next c
    
    FindLastDateColumnInRow = 0
End Function

'Adds unique normalized colors found in column E of a section range.
'Implements fill-down: blank color cells inherit the most recent non-blank color above within that section scan.
Private Sub AddColorsFromSection(ByRef colors As Collection, ByVal sectionRng As Range)
    Dim lastSeen As String
    lastSeen = ""
    
    Dim r As Long
    For r = 1 To sectionRng.Rows.Count
        Dim raw As String
        raw = Trim$(CStr(sectionRng.Cells(r, 3).Value)) 'Column E relative to sectionRng (C=1, D=2, E=3)
        
        If Len(raw) > 0 Then
            lastSeen = NormalizeColor(raw)
        ElseIf Len(lastSeen) > 0 Then
            'fill-down: use lastSeen
        Else
            'still nothing to use
        End If
        
        If Len(lastSeen) > 0 Then
            AddUniqueKeyed colors, lastSeen
        End If
    Next r
End Sub

'Normalize color strings so duplicates like " fog ", "FOG", "Fog" collapse to one key.
Private Function NormalizeColor(ByVal s As String) As String
    s = Trim$(s)
    If Len(s) = 0 Then
        NormalizeColor = ""
    Else
        NormalizeColor = UCase$(s)
    End If
End Function

'Cross-platform uniqueness using Collection keys (no Dictionary required).
Private Sub AddUniqueKeyed(ByRef col As Collection, ByVal key As String)
    On Error Resume Next
    col.Add key, key   'keyed add: duplicates throw error
    Err.Clear
    On Error GoTo 0
End Sub

'Returns a UNIQUE list of colors from a ListObject table where Status = "Active".
'TableName: name of the Excel table (ListObject), e.g. "Colors"
'ColorColName: header name for the color column, e.g. "Colors"
'StatusColName: header name for status, e.g. "Status"
Private Function GetActiveColorsFromTable(ByVal tableName As String, _
                                         ByVal colorColName As String, _
                                         ByVal statusColName As String) As Collection
    Dim result As New Collection
    
    Dim ws As Worksheet, lo As ListObject
    Dim found As Boolean
    found = False
    
    'Find the table anywhere in ThisWorkbook
    For Each ws In ThisWorkbook.Worksheets
        On Error Resume Next
        Set lo = ws.ListObjects(tableName)
        On Error GoTo 0
        
        If Not lo Is Nothing Then
            found = True
            Exit For
        End If
    Next ws
    
    If Not found Then
        'Return empty collection (or raise error if you prefer)
        Set GetActiveColorsFromTable = result
        Exit Function
    End If
    
    Dim colColor As ListColumn, colStatus As ListColumn
    Set colColor = lo.ListColumns(colorColName)
    Set colStatus = lo.ListColumns(statusColName)
    
    If lo.DataBodyRange Is Nothing Then
        Set GetActiveColorsFromTable = result
        Exit Function
    End If
    
    Dim i As Long
    For i = 1 To lo.DataBodyRange.Rows.Count
        Dim statusVal As String
        statusVal = Trim$(CStr(colStatus.DataBodyRange.Cells(i, 1).Value))
        
        If UCase$(statusVal) = "ACTIVE" Then
            Dim clr As String
            clr = NormalizeColor(CStr(colColor.DataBodyRange.Cells(i, 1).Value))
            If Len(clr) > 0 Then
                AddUniqueKeyed result, clr
            End If
        End If
    Next i
    
    Set GetActiveColorsFromTable = result
End Function

'Builds a 3 x N variant table:
'   tbl(1,i) = colorKey
'   tbl(2,i) = boxNum
'   tbl(3,i) = worksheetRow
Private Function BuildSectionIndex_FromRange(ByVal sectionRng As Range) As Variant
    If sectionRng Is Nothing Then
        BuildSectionIndex_FromRange = Empty
        Exit Function
    End If

    Dim tmp() As Variant, cnt As Long
    ReDim tmp(1 To 3, 1 To 1)

    Dim lastColorKey As String
    lastColorKey = ""

    Dim r As Long
    For r = 1 To sectionRng.Rows.Count

        'In your sectionRng: C=1, D=2, E=3
        Dim desc As String
        desc = CStr(sectionRng.Cells(r, 2).Value)   'Column D on sheet
        Dim bx As Long
        bx = ParseBoxNum(desc)
        If bx = 8 Then
            Dim U8 As String: U8 = UCase$(desc)
            If (InStr(1, U8, "NEW") > 0) And (InStr(1, U8, "ARMS") > 0 Or InStr(1, U8, "SRMS") > 0) Then
                GoTo NextRow
            End If
        End If
        If bx = 0 Then GoTo NextRow

        'Read color from Column E with fill-down
        Dim colorRaw As String, colorKey As String
        colorRaw = CStr(sectionRng.Cells(r, 3).Value) 'Column E on sheet
        colorKey = ""

        If IsLikelyColor(colorRaw) Then colorKey = NormalizeColor(colorRaw)
        If Len(colorKey) = 0 And Len(lastColorKey) > 0 Then colorKey = lastColorKey
        If Len(colorKey) = 0 Then GoTo NextRow

        lastColorKey = colorKey

        cnt = cnt + 1
        If cnt > UBound(tmp, 2) Then ReDim Preserve tmp(1 To 3, 1 To cnt)

        tmp(1, cnt) = colorKey
        tmp(2, cnt) = bx
        tmp(3, cnt) = sectionRng.Cells(r, 1).Row   'worksheet row number

NextRow:
    Next r

    If cnt = 0 Then
        BuildSectionIndex_FromRange = Empty
    Else
        BuildSectionIndex_FromRange = tmp
    End If
End Function

Private Function ParseBoxNum(ByVal s As String) As Long
    Dim U As String: U = UCase$(s)
    Dim p As Long: p = InStr(1, U, "BOX")
    If p = 0 Then Exit Function

    Dim i As Long, ch As String, numStr As String
    For i = p + 3 To Len(U)
        ch = Mid$(U, i, 1)

        'skip separators
        If ch = " " Or ch = "-" Or ch = ChrW(8211) Or ch = ChrW(8212) Or ch = ChrW(160) Then
            'skip
        ElseIf ch Like "#" Then
            numStr = numStr & ch
        ElseIf Len(numStr) > 0 Then
            Exit For
        End If
    Next i

    If Len(numStr) > 0 Then ParseBoxNum = CLng(numStr)
End Function

Private Function IsLikelyColor(ByVal v As Variant) As Boolean
    Dim s As String: s = Trim$(CStr(v))
    If Len(s) = 0 Then Exit Function
    If IsNumeric(s) Then Exit Function
    On Error Resume Next
    If IsDate(s) Then Exit Function
    On Error GoTo 0

    Dim i As Long, ch As String
    For i = 1 To Len(s)
        ch = Mid$(s, i, 1)
        If ch Like "[A-Za-z]" Then IsLikelyColor = True: Exit Function
    Next i
End Function

Private Function GetBoxCountFromTable(ByVal tableName As String) As Long
    Dim ws As Worksheet, lo As ListObject

    'Find the table anywhere in ThisWorkbook
    For Each ws In ThisWorkbook.Worksheets
        On Error Resume Next
        Set lo = ws.ListObjects(tableName)
        On Error GoTo 0

        If Not lo Is Nothing Then
            'DataBodyRange excludes header row
            If lo.DataBodyRange Is Nothing Then
                GetBoxCountFromTable = 0
            Else
                GetBoxCountFromTable = lo.DataBodyRange.Rows.Count
            End If
            Exit Function
        End If
    Next ws

    'Not found
    GetBoxCountFromTable = 0
End Function

'Builds a fast lookup:
'   key = "COLOR|BOX"  ->  worksheetRow
'First match wins (handles duplicates like discontinued items).
Private Function BuildRowMap(ByVal tbl As Variant) As Object
    Dim m As Object
    Set m = MapCreate()

    If IsEmpty(tbl) Then
        Set BuildRowMap = m
        Exit Function
    End If

    Dim i As Long, k As String
    For i = 1 To UBound(tbl, 2)
        k = CStr(tbl(1, i)) & "|" & CStr(tbl(2, i))
        MapAddFirst m, k, CLng(tbl(3, i))
    Next i

    Set BuildRowMap = m
End Function

'==================== CROSS-PLATFORM MAP ====================
' Uses Scripting.Dictionary if available; otherwise falls back to Collection of [key,value] pairs.

Private Function MapCreate() As Object
    'Try Dictionary first (Windows)
    On Error Resume Next
    Dim d As Object
    Set d = CreateObject("Scripting.Dictionary")
    On Error GoTo 0

    If Not d Is Nothing Then
        d.CompareMode = 1 ' vbTextCompare
        Set MapCreate = d
    Else
        Dim c As Collection
        Set c = New Collection
        Set MapCreate = c
    End If
End Function

Private Function MapIsDictionary(ByVal m As Object) As Boolean
    MapIsDictionary = (TypeName(m) = "Dictionary")
End Function

Private Function MapExists(ByVal m As Object, ByVal key As String) As Boolean
    If MapIsDictionary(m) Then
        MapExists = m.Exists(key)
    Else
        Dim i As Long, pair As Variant
        For i = 1 To m.Count
            pair = m(i) ' pair = Array(key, value)
            If StrComp(CStr(pair(0)), key, vbTextCompare) = 0 Then
                MapExists = True
                Exit Function
            End If
        Next i
        MapExists = False
    End If
End Function

Private Sub MapAddFirst(ByVal m As Object, ByVal key As String, ByVal value As Long)
    'Add only if missing (first match wins)
    If MapExists(m, key) Then Exit Sub

    If MapIsDictionary(m) Then
        m.Add key, value
    Else
        Dim pair As Variant
        pair = Array(key, value)
        m.Add pair
    End If
End Sub

Private Function MapGetLong(ByVal m As Object, ByVal key As String, Optional ByVal defaultValue As Long = 0) As Long
    If MapIsDictionary(m) Then
        If m.Exists(key) Then
            MapGetLong = CLng(m(key))
        Else
            MapGetLong = defaultValue
        End If
    Else
        Dim i As Long, pair As Variant
        For i = 1 To m.Count
            pair = m(i)
            If StrComp(CStr(pair(0)), key, vbTextCompare) = 0 Then
                MapGetLong = CLng(pair(1))
                Exit Function
            End If
        Next i
        MapGetLong = defaultValue
    End If
End Function

Private Function ToWhole(ByVal v As Variant) As Long
    'Round to nearest whole number; handles blanks/errors safely
    If IsError(v) Or Len(Trim$(CStr(v))) = 0 Then
        ToWhole = 0
    Else
        ToWhole = CLng(Application.WorksheetFunction.Round(CDbl(v), 0))
    End If
End Function

